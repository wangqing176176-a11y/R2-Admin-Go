<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF 预览</title>
    <style>
      :root {
        color-scheme: light;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC",
          "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background: #f2f4f7;
        color: #1f2937;
      }
      .app {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .toolbar {
        height: 52px;
        border-bottom: 1px solid #e5e7eb;
        background: #ffffff;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        flex-wrap: wrap;
      }
      .group {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      button,
      input,
      select {
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #111827;
        border-radius: 8px;
        height: 34px;
        font-size: 13px;
      }
      button {
        padding: 0 12px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }
      input {
        width: 64px;
        text-align: center;
      }
      select {
        min-width: 94px;
        padding: 0 8px;
      }
      .hint {
        font-size: 12px;
        color: #6b7280;
      }
      .viewer-wrap {
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding: 14px;
      }
      .page-card {
        margin: 0 auto;
        display: flex;
        justify-content: center;
      }
      canvas {
        background: #ffffff;
        border: 1px solid #d1d5db;
        box-shadow: 0 8px 24px rgba(17, 24, 39, 0.08);
        max-width: 100%;
        height: auto;
      }
      .status {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: rgba(17, 24, 39, 0.85);
        color: #ffffff;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 13px;
        z-index: 2;
      }
      .error {
        margin: 36px auto;
        max-width: 760px;
        background: #ffffff;
        border: 1px solid #fecaca;
        color: #7f1d1d;
        border-radius: 12px;
        padding: 16px;
        line-height: 1.6;
        font-size: 14px;
      }
      .error code {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        background: #fff5f5;
        padding: 1px 4px;
        border-radius: 4px;
      }
      @media (max-width: 640px) {
        .toolbar {
          height: auto;
          padding: 8px;
          gap: 8px;
        }
        .hint {
          width: 100%;
          order: 20;
        }
        .viewer-wrap {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="toolbar">
        <div class="group">
          <button id="prevBtn" type="button">上一页</button>
          <button id="nextBtn" type="button">下一页</button>
        </div>
        <div class="group">
          <input id="pageInput" type="number" min="1" value="1" />
          <span id="pageTotal" class="hint">/ 0</span>
        </div>
        <div class="group">
          <button id="zoomOutBtn" type="button">-</button>
          <button id="zoomInBtn" type="button">+</button>
          <select id="zoomSelect">
            <option value="auto">自动宽度</option>
            <option value="0.75">75%</option>
            <option value="1">100%</option>
            <option value="1.25">125%</option>
            <option value="1.5">150%</option>
            <option value="2">200%</option>
          </select>
        </div>
        <span id="zoomText" class="hint">缩放：-</span>
      </div>

      <div id="viewerWrap" class="viewer-wrap">
        <div class="page-card">
          <canvas id="pdfCanvas"></canvas>
        </div>
        <div id="errorBox" class="error" style="display: none"></div>
      </div>
    </div>

    <div id="status" class="status">正在加载 PDF...</div>

    <script type="module">
      import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.mjs";

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs";

      const params = new URLSearchParams(window.location.search);
      const file = params.get("file") || "";

      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const zoomOutBtn = document.getElementById("zoomOutBtn");
      const zoomInBtn = document.getElementById("zoomInBtn");
      const pageInput = document.getElementById("pageInput");
      const pageTotal = document.getElementById("pageTotal");
      const zoomSelect = document.getElementById("zoomSelect");
      const zoomText = document.getElementById("zoomText");
      const statusEl = document.getElementById("status");
      const errorBox = document.getElementById("errorBox");
      const viewerWrap = document.getElementById("viewerWrap");
      const canvas = document.getElementById("pdfCanvas");
      const ctx = canvas.getContext("2d", { alpha: false });

      let pdfDoc = null;
      let pageNum = 1;
      let numPages = 0;
      let scale = 1;
      let renderTask = null;
      let fitWidthMode = true;
      let rendering = false;

      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
      const setStatus = (text) => {
        statusEl.textContent = text;
        statusEl.style.display = text ? "block" : "none";
      };
      const setError = (text) => {
        if (!text) {
          errorBox.style.display = "none";
          errorBox.textContent = "";
          return;
        }
        errorBox.style.display = "block";
        errorBox.innerHTML = text;
      };
      const updateToolbar = () => {
        pageInput.value = String(pageNum);
        pageInput.max = String(numPages || 1);
        pageTotal.textContent = `/ ${numPages || 0}`;
        prevBtn.disabled = pageNum <= 1 || rendering;
        nextBtn.disabled = pageNum >= numPages || rendering;
        zoomOutBtn.disabled = rendering;
        zoomInBtn.disabled = rendering;
        zoomSelect.disabled = rendering;
        zoomText.textContent = `缩放：${Math.round(scale * 100)}%`;
      };

      const computeFitScale = (viewportWidth) => {
        const padding = 28;
        const available = Math.max(120, viewerWrap.clientWidth - padding);
        return clamp(available / viewportWidth, 0.3, 4);
      };

      const renderPage = async (targetPage) => {
        if (!pdfDoc) return;
        const safePage = clamp(targetPage, 1, numPages);
        pageNum = safePage;
        setError("");
        setStatus("正在渲染页面...");
        updateToolbar();

        if (renderTask) {
          try {
            renderTask.cancel();
          } catch {
            // ignore
          }
          renderTask = null;
        }

        rendering = true;
        try {
          const page = await pdfDoc.getPage(safePage);
          const base = page.getViewport({ scale: 1 });
          if (fitWidthMode) {
            scale = computeFitScale(base.width);
          }
          const viewport = page.getViewport({ scale });

          const dpr = window.devicePixelRatio || 1;
          canvas.width = Math.floor(viewport.width * dpr);
          canvas.height = Math.floor(viewport.height * dpr);
          canvas.style.width = `${Math.floor(viewport.width)}px`;
          canvas.style.height = `${Math.floor(viewport.height)}px`;

          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          renderTask = page.render({ canvasContext: ctx, viewport });
          await renderTask.promise;
          renderTask = null;
          setStatus("");
        } catch (error) {
          if (error && error.name === "RenderingCancelledException") {
            return;
          }
          const msg = error && error.message ? error.message : String(error || "未知错误");
          setError(`PDF 渲染失败：${msg}`);
          setStatus("");
        } finally {
          rendering = false;
          updateToolbar();
        }
      };

      const changeZoom = async (nextScale, auto = false) => {
        fitWidthMode = auto;
        if (!auto) scale = clamp(nextScale, 0.3, 4);
        await renderPage(pageNum);
      };

      const openPdf = async () => {
        if (!file) {
          setStatus("");
          setError("缺少 <code>file</code> 参数，无法加载 PDF。");
          return;
        }
        setStatus("正在加载 PDF...");
        setError("");

        try {
          const task = pdfjsLib.getDocument({
            url: file,
            cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/cmaps/",
            cMapPacked: true,
            standardFontDataUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/standard_fonts/",
          });
          pdfDoc = await task.promise;
          numPages = pdfDoc.numPages || 0;
          pageNum = 1;
          updateToolbar();
          await renderPage(1);
        } catch (error) {
          const msg = error && error.message ? error.message : String(error || "未知错误");
          setStatus("");
          setError(
            `加载 PDF 失败：${msg}<br/>建议检查：<br/>1. 当前通道是否可达（R2 直连 / Pages 代理）<br/>2. R2 CORS 是否允许 <code>GET/HEAD</code> 与 <code>Range</code>。`
          );
        }
      };

      prevBtn.addEventListener("click", () => {
        if (pageNum <= 1 || rendering) return;
        renderPage(pageNum - 1);
      });

      nextBtn.addEventListener("click", () => {
        if (pageNum >= numPages || rendering) return;
        renderPage(pageNum + 1);
      });

      pageInput.addEventListener("change", () => {
        const parsed = Number.parseInt(pageInput.value, 10);
        if (!Number.isFinite(parsed)) {
          pageInput.value = String(pageNum);
          return;
        }
        renderPage(parsed);
      });

      zoomOutBtn.addEventListener("click", () => {
        if (rendering) return;
        void changeZoom(scale - 0.1, false);
      });

      zoomInBtn.addEventListener("click", () => {
        if (rendering) return;
        void changeZoom(scale + 0.1, false);
      });

      zoomSelect.addEventListener("change", () => {
        if (rendering) return;
        if (zoomSelect.value === "auto") {
          void changeZoom(scale, true);
        } else {
          const parsed = Number.parseFloat(zoomSelect.value);
          if (!Number.isFinite(parsed)) return;
          void changeZoom(parsed, false);
        }
      });

      window.addEventListener("keydown", (event) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault();
          if (!rendering) void renderPage(pageNum - 1);
        }
        if (event.key === "ArrowRight") {
          event.preventDefault();
          if (!rendering) void renderPage(pageNum + 1);
        }
      });

      const onResize = () => {
        if (!pdfDoc || !fitWidthMode || rendering) return;
        void renderPage(pageNum);
      };
      window.addEventListener("resize", onResize);

      updateToolbar();
      void openPdf();
    </script>
  </body>
</html>
