(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["chunks/_9e53a90f._.js",84256,e=>{"use strict";async function t(){return"_ENTRIES"in globalThis&&_ENTRIES.middleware_instrumentation&&await _ENTRIES.middleware_instrumentation}let r=null;async function a(){if("phase-production-build"===process.env.NEXT_PHASE)return;r||(r=t());let e=await r;if(null==e?void 0:e.register)try{await e.register()}catch(e){throw e.message=`An error occurred while loading instrumentation hook: ${e.message}`,e}}async function n(...e){let r=await t();try{var a;await (null==r||null==(a=r.onRequestError)?void 0:a.call(r,...e))}catch(e){console.error("Error in instrumentation.onRequestError:",e)}}let s=null;function i(){return s||(s=a()),s}function o(e){return`The edge runtime does not support Node.js '${e}' module.
Learn More: https://nextjs.org/docs/messages/node-module-in-edge-runtime`}process!==e.g.process&&(process.env=e.g.process.env,e.g.process=process);try{Object.defineProperty(globalThis,"__import_unsupported",{value:function(e){let t=new Proxy(function(){},{get(t,r){if("then"===r)return{};throw Object.defineProperty(Error(o(e)),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})},construct(){throw Object.defineProperty(Error(o(e)),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})},apply(r,a,n){if("function"==typeof n[0])return n[0](t);throw Object.defineProperty(Error(o(e)),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}});return new Proxy({},{get:()=>t})},enumerable:!1,configurable:!1})}catch{}i(),e.s(["edgeInstrumentationOnRequestError",()=>n,"ensureInstrumentationRegistered",()=>i,"getEdgeInstrumentationModule",()=>t])},1164,4648,e=>{"use strict";var t=e.i(51615),r=e.i(84442);let a=new TextEncoder,n=new TextDecoder,s=e=>(e=>{if(void 0!==t.Buffer)return t.Buffer.from(e).toString("base64");let r="";for(let t of e)r+=String.fromCharCode(t);return btoa(r)})(e).replaceAll("+","-").replaceAll("/","_").replaceAll("=",""),i=e=>{let r=e.replaceAll("-","+").replaceAll("_","/");var a=r+"=".repeat((4-(r.length%4||4))%4);if(void 0!==t.Buffer)return new Uint8Array(t.Buffer.from(a,"base64"));let n=atob(a),s=new Uint8Array(n.length);for(let e=0;e<n.length;e++)s[e]=n.charCodeAt(e);return s},o=async(e,t)=>{let r=await crypto.subtle.digest("SHA-256",a.encode(`${t}:${e}`));return await crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt","decrypt"])},u=async(e,t,r)=>{let n=await o(e,t),i=crypto.getRandomValues(new Uint8Array(12)),u=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},n,a.encode(r));return`v1.${s(i)}.${s(new Uint8Array(u))}`},c=async(e,t,r)=>{let[a,s,u]=r.split(".",3);if("v1"!==a||!s||!u)throw Error("密文格式无效");let c=await o(e,t),l=i(s),d=i(u);try{let e=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},c,d);return n.decode(new Uint8Array(e))}catch{throw Error("密钥解密失败：请检查 CREDENTIALS_ENCRYPTION_KEY 是否与历史配置一致。")}},l=()=>(0,r.requireEnvString)("CREDENTIALS_ENCRYPTION_KEY"),d=()=>{let e=(0,r.getEnvString)("ROUTE_TOKEN_SECRET","ACCESS_TOKEN_SECRET","CREDENTIALS_ENCRYPTION_KEY");if(!e)throw Error("缺少环境变量：ROUTE_TOKEN_SECRET 或 CREDENTIALS_ENCRYPTION_KEY");return e},p=async e=>await u(l(),"bucket-credential",e),_=async e=>e?e.startsWith("v1.")?await c(l(),"bucket-credential",e):e:"",f=async(e,t=900)=>{let r=JSON.stringify({exp:Math.floor(Date.now()/1e3)+Math.max(30,Math.min(86400,t)),payload:e});return await u(d(),"route-token",r)},b=async e=>{let t=JSON.parse(await c(d(),"route-token",e)),r=Number(t.exp??NaN);if(!Number.isFinite(r)||r<Math.floor(Date.now()/1e3))throw Error("操作令牌已过期，请重试。");return t.payload};e.s(["decryptCredential",0,_,"encryptCredential",0,p,"issueSealedPayload",0,f,"readSealedPayload",0,b],4648);var m=e.i(51959);let h="id,user_id,bucket_label,bucket_name,account_id,access_key_id_enc,secret_access_key_enc,public_base_url,custom_base_url,transfer_mode_override,is_default,created_at,updated_at",E=e=>{let t=String(e??"").trim();if(!t)return;let r=/^https?:\/\//i.test(t)?t:`https://${t}`;return r.endsWith("/")?r:`${r}/`},w=e=>String(e??"").trim(),R=e=>String(e??"").trim(),y=e=>({id:e.id,Name:e.bucket_label||e.bucket_name,CreationDate:e.created_at,transferMode:"presigned",bucketLabel:e.bucket_label||e.bucket_name,bucketName:e.bucket_name,accountId:e.account_id,isDefault:!!e.is_default,publicBaseUrl:E(e.public_base_url),customBaseUrl:E(e.custom_base_url)}),g=async(e,t,r)=>{let a=await (0,m.supabaseRestFetch)(e,{token:t,method:"GET"});return await (0,m.readSupabaseRestArray)(a,r)},v=async(e,t)=>{if(await (0,m.supabaseRestFetch)("user_r2_buckets?is_default=eq.true",{token:e,method:"PATCH",body:{is_default:!1}}),!(await (0,m.supabaseRestFetch)(`user_r2_buckets?id=eq.${encodeURIComponent(t)}`,{token:e,method:"PATCH",body:{is_default:!0},prefer:"return=minimal"})).ok)throw Error("设置默认存储桶失败")},k=async e=>{if((await g("user_r2_buckets?select=id&is_default=eq.true&limit=1",e,"读取默认存储桶失败")).length>0)return;let t=await g("user_r2_buckets?select=id&order=created_at.asc&limit=1",e,"读取存储桶列表失败");t[0]?.id&&await v(e,String(t[0].id))},N=async e=>(await g(`user_r2_buckets?select=${h}&order=is_default.desc,created_at.asc`,e,"读取存储桶列表失败")).map(y),C=async(e,t)=>{let r=(await g(`user_r2_buckets?select=${h}&id=eq.${encodeURIComponent(t)}&limit=1`,e,"读取存储桶信息失败"))[0];if(!r)throw Error("未找到存储桶");return{id:r.id,userId:r.user_id,bucketLabel:r.bucket_label||r.bucket_name,bucketName:r.bucket_name,accountId:r.account_id,accessKeyId:await _(r.access_key_id_enc),secretAccessKey:await _(r.secret_access_key_enc),publicBaseUrl:E(r.public_base_url),customBaseUrl:E(r.custom_base_url),transferModeOverride:"auto"===r.transfer_mode_override||"presigned"===r.transfer_mode_override||"proxy"===r.transfer_mode_override?r.transfer_mode_override:void 0,isDefault:!!r.is_default,createdAt:r.created_at,updatedAt:r.updated_at}},S=async(e,t)=>{let r=await C(e,t);return{detail:r,creds:{accountId:r.accountId,accessKeyId:r.accessKeyId,secretAccessKey:r.secretAccessKey,bucketName:r.bucketName}}},A=async(e,t,r)=>{var a;let n,s=w(r.bucketName),i=R(r.accountId),o=(a=r.bucketLabel,(n=String(a??"").trim())||String(s??"").trim()),u=String(r.accessKeyId??"").trim(),c=String(r.secretAccessKey??"").trim();if(!s)throw Error("桶名称不能为空");if(!/^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$/i.test(s))throw Error("桶名称格式不正确");if(!i)throw Error("Account ID 不能为空");if(!u)throw Error("Access Key ID 不能为空");if(!c)throw Error("Secret Access Key 不能为空");let l=await g(`user_r2_buckets?select=${h}&account_id=eq.${encodeURIComponent(i)}&bucket_name=eq.${encodeURIComponent(s)}&limit=1`,e,"校验存储桶是否已存在失败");if(l[0]?.id)return await T(e,l[0].id,{bucketLabel:r.bucketLabel,bucketName:s,accountId:i,accessKeyId:u,secretAccessKey:c,publicBaseUrl:r.publicBaseUrl,customBaseUrl:r.customBaseUrl,transferModeOverride:r.transferModeOverride,isDefault:!0===r.isDefault});let d={user_id:t,bucket_label:o,bucket_name:s,account_id:i,access_key_id_enc:await p(u),secret_access_key_enc:await p(c),public_base_url:E(r.publicBaseUrl)??null,custom_base_url:E(r.customBaseUrl)??null,transfer_mode_override:"auto"===r.transferModeOverride||"presigned"===r.transferModeOverride||"proxy"===r.transferModeOverride?r.transferModeOverride:null,is_default:!!r.isDefault},_=await (0,m.supabaseRestFetch)("user_r2_buckets",{token:e,method:"POST",body:d,prefer:"return=representation"}),f=(await (0,m.readSupabaseRestArray)(_,"新增存储桶失败"))[0];if(!f?.id)throw Error("新增存储桶失败");return d.is_default?await v(e,f.id):await k(e),y(f)},T=async(e,t,r)=>{let a={};if(void 0!==r.bucketName){let e=w(r.bucketName);if(!e)throw Error("桶名称不能为空");if(!/^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$/i.test(e))throw Error("桶名称格式不正确");a.bucket_name=e}if(void 0!==r.bucketLabel){let e=String(r.bucketLabel??"").trim();e&&(a.bucket_label=e)}if(void 0!==r.accountId){let e=R(r.accountId);if(!e)throw Error("Account ID 不能为空");a.account_id=e}if(void 0!==r.accessKeyId){let e=String(r.accessKeyId??"").trim();e&&(a.access_key_id_enc=await p(e))}if(void 0!==r.secretAccessKey){let e=String(r.secretAccessKey??"").trim();e&&(a.secret_access_key_enc=await p(e))}if(void 0!==r.publicBaseUrl&&(a.public_base_url=E(r.publicBaseUrl)??null),void 0!==r.customBaseUrl&&(a.custom_base_url=E(r.customBaseUrl)??null),void 0!==r.transferModeOverride&&(a.transfer_mode_override="auto"===r.transferModeOverride||"presigned"===r.transferModeOverride||"proxy"===r.transferModeOverride?r.transferModeOverride:null),Object.keys(a).length>0){let r=await (0,m.supabaseRestFetch)(`user_r2_buckets?id=eq.${encodeURIComponent(t)}`,{token:e,method:"PATCH",body:a,prefer:"return=representation"}),n=await (0,m.readSupabaseRestArray)(r,"更新存储桶失败");if(!n[0]?.id)throw Error("未找到存储桶")}!0===r.isDefault&&await v(e,t);let n=(await g(`user_r2_buckets?select=${h}&id=eq.${encodeURIComponent(t)}&limit=1`,e,"刷新存储桶信息失败"))[0];if(!n)throw Error("未找到存储桶");return y(n)},O=async(e,t)=>{let r=await (0,m.supabaseRestFetch)(`user_r2_buckets?id=eq.${encodeURIComponent(t)}`,{token:e,method:"DELETE",prefer:"return=minimal"});if(!r.ok)throw Error(await r.text().catch(()=>"")||"删除存储桶失败");await k(e)},U=async(e,t)=>{await v(e,t)};e.s(["createUserBucket",0,A,"deleteUserBucket",0,O,"listUserBucketViews",0,N,"resolveBucketCredentials",0,S,"setDefaultBucket",0,U,"updateUserBucket",0,T],1164)},21523,(e,t,r)=>{self._ENTRIES||={};let a=Promise.resolve().then(()=>e.i(85028));a.catch(()=>{}),self._ENTRIES["middleware_app/api/buckets/route"]=new Proxy(a,{get(e,t){if("then"===t)return(t,r)=>e.then(t,r);let r=(...r)=>e.then(e=>(0,e[t])(...r));return r.then=(r,a)=>e.then(e=>e[t]).then(r,a),r}})},85028,e=>{"use strict";let t;var r,a=e.i(92480),n=e.i(87259),s=e.i(51615),i=e.i(73246),o=e.i(23646),u=e.i(32995),c=e.i(4842),l=e.i(68045),d=e.i(87167),p=e.i(20900),_=e.i(83877),f=e.i(64927),b=e.i(66163),m=e.i(16423),h=e.i(63402),E=e.i(40409),w=e.i(14327),R=e.i(80441);e.i(27064);var y=e.i(34277);e.i(44549);var g=e.i(20964),v=e.i(51959),k=e.i(1164),N=e.i(12454);let C=e=>{let t=Number(e?.status??NaN);return Number.isFinite(t)&&t>=100?t:500},S=e=>(0,N.toChineseErrorMessage)(e,"存储桶操作失败，请稍后重试。");async function A(e){try{let t=await (0,v.requireSupabaseUser)(e),r=await (0,k.listUserBucketViews)(t.token);return g.NextResponse.json({buckets:r})}catch(e){return g.NextResponse.json({error:S(e)},{status:C(e)})}}async function T(e){try{let t=await (0,v.requireSupabaseUser)(e),r=await e.json(),a=await (0,k.createUserBucket)(t.token,t.user.id,r);return g.NextResponse.json({bucket:a})}catch(e){return g.NextResponse.json({error:S(e)},{status:C(e)})}}async function O(e){try{let t=await (0,v.requireSupabaseUser)(e),r=await e.json(),a=String(r.id??"").trim();if(!a)return g.NextResponse.json({error:"缺少存储桶 ID"},{status:400});if(r.setDefaultOnly){await (0,k.setDefaultBucket)(t.token,a);let e=await (0,k.listUserBucketViews)(t.token);return g.NextResponse.json({buckets:e})}let n={...r};delete n.id,delete n.setDefaultOnly;let s=await (0,k.updateUserBucket)(t.token,a,n);return g.NextResponse.json({bucket:s})}catch(e){return g.NextResponse.json({error:S(e)},{status:C(e)})}}async function U(e){try{let t=await (0,v.requireSupabaseUser)(e),{searchParams:r}=new URL(e.url),a=String(r.get("id")??"").trim();if(!a)return g.NextResponse.json({error:"缺少存储桶 ID"},{status:400});return await (0,k.deleteUserBucket)(t.token,a),g.NextResponse.json({success:!0})}catch(e){return g.NextResponse.json({error:S(e)},{status:C(e)})}}e.s(["DELETE",()=>U,"GET",()=>A,"PATCH",()=>O,"POST",()=>T,"runtime",0,"edge"],68261);var I=e.i(68261);let x=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/buckets/route",pathname:"/api/buckets",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/buckets/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:P,workUnitAsyncStorage:M,serverHooks:D}=x;function B(){return(0,u.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:M})}async function K(e,t,r){x.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/buckets/route";n=n.replace(/\/index$/,"")||"/";let i=await x.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:u,params:g,nextConfig:v,parsedUrl:k,isDraftMode:N,prerenderManifest:C,routerServerContext:S,isOnDemandRevalidate:A,revalidateOnlyGenerated:T,resolvedPathname:O,clientReferenceManifest:U,serverActionsManifest:I}=i,P=(0,d.normalizeAppPath)(n),M=!!(C.dynamicRoutes[P]||C.routes[O]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,k,!1):t.end("This page could not be found"),null);if(M&&!N){let e=!!C.routes[O],t=C.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await D();throw new R.NoFallbackError}}let B=null;!M||x.isDev||N||(B="/index"===(B=O)?"/":B);let K=!0===x.isDev||!M,q=M&&!K;I&&U&&(0,a.setManifestsSingleton)({page:n,clientReferenceManifest:U,serverActionsManifest:I});let $=e.method||"GET",j=(0,l.getTracer)(),H=j.getActiveScopeSpan(),L={params:g,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:K,incrementalCache:(0,c.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>x.onRequestError(e,t,a,n,S)},sharedContext:{buildId:u}},F=new p.NodeNextRequest(e),G=new p.NodeNextResponse(t),V=_.NextRequestAdapter.fromNodeNextRequest(F,(0,_.signalFromNodeResponse)(t));try{let a=async e=>x.handle(V,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${n}`)}),i=!!(0,c.getRequestMeta)(e,"minimalMode"),u=async u=>{var c,l;let d=async({previousCacheEntry:o})=>{try{if(!i&&A&&T&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(u);e.fetchMetrics=L.renderOpts.fetchMetrics;let c=L.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=L.renderOpts.collectedTags;if(!M)return await (0,m.sendResponse)(F,G,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:s.Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==o?void 0:o.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,b.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},!1,S),t}},p=await x.handleResponse({req:e,nextConfig:v,cacheKey:B,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:i});if(!M)return null;if((null==p||null==(c=p.value)?void 0:c.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",A?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,h.fromNodeOutgoingHttpHeaders)(p.value.headers);return i&&M||_.delete(w.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,E.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(F,G,new Response(p.value.body,{headers:_,status:p.value.status||200})),null};H?await u(H):await j.withPropagatedContext(e.headers,()=>j.trace(f.BaseServerSpan.handleRequest,{spanName:`${$} ${n}`,kind:l.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,b.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},!1,S),M)throw t;return await (0,m.sendResponse)(F,G,new Response(null,{status:500})),null}}e.s(["handler",()=>K,"patchFetch",()=>B,"routeModule",()=>x,"serverHooks",()=>D,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>M],75528);var q=e.i(75528);let $=null==(r=self.__RSC_MANIFEST)?void 0:r["/api/buckets/route"],j=(t=self.__RSC_SERVER_MANIFEST)?JSON.parse(t):void 0;$&&j&&(0,a.setManifestsSingleton)({page:"/api/buckets/route",clientReferenceManifest:$,serverActionsManifest:j});let H=n.EdgeRouteModuleWrapper.wrap(q.routeModule,{page:"/api/buckets/route"});e.s(["ComponentMod",0,q,"default",0,H],85028)}]);

//# sourceMappingURL=_9e53a90f._.js.map